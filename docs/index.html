<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>An Introduction to Modern Authentication and Authorization</title>

		<meta name="description" content="Theory and hands-on examples to do web based Authentication and Authorization">
		<meta name="author" content="Lars Kåre Skjørestad">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/moon.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5sßhiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<!-- Front page -->
				<section style="text-align: left;">
					<h1>Modern A&A</h1>
					<h4>Authentication (OpenID) and Authorization (oAuth2)</h3>
					<small>An introduction to a vast and complex topic</small>
					<p>
						<small><a href="https://loop.equinor.com" target="_blank">Equinor</a></Equinor> <font style="color:red;">#AppSec</font> community</a></small>
					</p>
				</section>

				<!-- Objectives part-->
				<section>
					<section>
						<h1>Objectives</h1>
					</section>

					<section>
						<h3>Workshop objectives </h3>
						<blockquote>Enable participants to continue exploring a&a with a bit more confidence</blockquote>
						<ul>
							<li>a introduction to basics modern web A&A</li>
							<li>specs, protocols, grants & flows</li>
							<li>hands-on with a few A&A scenarios </li>
							<li>insight into threat modelling and good security practices</li>
						</ul>
					</section>

				</section>
				
<!-- Outlines part-->
				<section>
					<section>
						<h1>Outline</h1>
					</section>
					<section style="text-align: left;">
						<h3>Workshop outline</h3>
						<ul>
							<li>Pre-requisites, Practicalities</li>
							<li>The basics of A&A </li>
							<li>Exercises (11)</li>
							<li>Prepare web app, add authentication, get access token, use access token, using frameworks & libraries, accessing 3rd party api, refresh tokens, single page web app (SPA), protecting web api's & DevOps (Radix)
							<li>Security</li>
							<li>Hack your own project</li>
						</ul>
					</section>
				</section>

<!-- Disclaimer part-->
				<section>
					<h1>Disclaimer</h1>
					<p>The more I learn about the topic the more I realize how complex it is. I am not an expert - in fact I am not even sure what an expert in this field is. I want to share what I think I know. I assume that quite a few of you know some of these topics a lot better than me. We would really appreciate your insight! Sharing is caring!</p>
					<p style="color:yellow">Code examples are not production quality</p>
				</section>
				
<!-- Pre-requisites part-->
				<section>
					<section>
						<h1>Pre-Requisites</h1>
					</section>
					<section>
						<h2>Roles</h2>
						<ul>
							<li>Valid Equinor Software Developer On-Boarding</li>
							<li>Valid role <strong>Application Developer (Azure Active Directory)</strong> - apply in AccessIT</li>
							<li>Valid role <strong>Radix Playground User (OMNIA RADIX)</strong> - apply in AccessIT</li>
						</ul>					
					</section>
					<section>
							<h2>Skills</h2>
							<p>Helpful knowledge:
								<ul>
									<li><a href="https://httpwg.org/specs/" target="_blank">HTTP</a></li>
									<li>JavaScript/Node.js</li>
									<li>Docker</li>
								</ul>
							</p>					
					</section>
					<section>
							<h2>Software</h2>
							<small>Installed and verified working software</small></br>
								<ul>
									<li><a href="https://nodejs.org/en/" target"_blank">Node.js</a></li>
									<li>(I recommned installing node version manager <a href="https://github.com/nvm-sh/nvm" target="_blank">nvm</a>)</li>
									<li>Development IDE (<a target="_blank" href="https://code.visualstudio.com"> like VS Code</a>)</li>
									<li><a href="https://git-scm.com/" target="_blank">git</a>, account in <a href="https://github.com/" target="_blank">github.com</a></li>
									<li><a href="https://www.getpostman.com/downloads/" target="_blank">Postman</a></li>
									<li>(Docker)</li>
								</ul>
					</section>	
				</section>

<!-- The practicalities & useful links part -->
				<section>
					<section>
						<h1>Practicalities</h1>
						<h3>#slack channel</h3>
					</section>
					<section>
							<h1>Useful links</h1>
							<small>
								<ul>
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/" target="_blank">Microsoft Identity Platform</a></li>
									<li><a href="https://oauth.net/2/" target="_blank">oAuth2.net</a></li>
									<li><a href="https://tools.ietf.org/html/rfc6749" target="_blank">The OAuth Authorization Framework (rfc 6749)</a></li>
									<li><a href="https://openid.net/connect/" target="_blank">OpenID Connect</a></li>
								</ul>
							</small>
						</section>
		
				</section>

<!-- The basic of A&A -->
				<section>
					<section>
						<h1>The basics of A&A</h1>
					</section>
					<section>
						<h3>Authentication vs. Authorization</h3>
						<p><span style="color:red">Authentication</span> =</br>is the mechanism to verify the identity of a user</p>
						<p><span style="color:red">Authorization</span> = </br>is the mechanism to verify access to a resource</p>
					</section>
					<section>
						<h3>oAuth2</h3>
						<blockquote style="font-size: 80%">
						The OAuth 2.0 authorization framework enables a third-party application to obtain limited access to an HTTP service, either on behalf of a resource owner by orchestrating an approval interaction between the resource owner and the HTTP service, or by allowing the third-party application to obtain access on its own behalf. </blockquote>
						<small><a href="https://tools.ietf.org/html/rfc6749" target="_blank">oAuth2</a> is a <strong>delegation protocol</strong>, a means of letting someone who controls a resource to let application access the resource ont their behalf (without impersonating).</small>
					</section>
					<section style="font-size: 75%">
						<h3>Roles</h3>
						<p><div style="color:yellow">resource owner</div>
						An entity capable of granting access to a protected resource.
						When the resource owner is a person, it is referred to as an
						end-user.
						</p>
						<p><div style="color:yellow">resource server</div>
						The server hosting the protected resources, capable of accepting
						and responding to protected resource requests using access tokens.
						</p>
						<p><div style="color:yellow">client</div>
						An application making protected resource requests on behalf of the
						resource owner and with its authorization.  The term "client" does
						not imply any particular implementation characteristics (e.g.,
						whether the application executes on a server, a desktop, or other
						devices).
						</p>
						<p><div style="color:yellow"> authorization server</div>				
						The server issuing access tokens to the client after successfully
						authenticating the resource owner and obtaining authorization.
						</p>
					</section>
					<section>
						<h4>Protocol flow</h4>
						<pre>
+--------+                               +---------------+
|        |--(A)- Authorization Request ->|   Resource    |
|        |                               |     Owner     |
|        |<-(B)-- Authorization Grant ---|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(C)-- Authorization Grant -->| Authorization |
| Client |                               |     Server    |
|        |<-(D)----- Access Token -------|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(E)----- Access Token ------>|    Resource   |
|        |                               |     Server    |
|        |<-(F)--- Protected Resource ---|               |
+--------+                               +---------------+

						</pre>
					</section>
					<section>
						<h4 style="text-align: left;">High level oAuth flow</h4>
						<pre style="font-size: 40%; text-align: left;">
+-- <span style="color:red">Resource</span> --+ +-- <span style="color: yellow;">Client</span> -- + +- <span style="color:yellowgreen">Authorization</span> -+ +--<span style="color:violet"> Protected</span> --+
+    Owner     + +             + +     Server      + +   Resource    +
+--------------+ +-------------+ +-----------------+ +---------------+
     -                   -                -                     -
     |  <span style="color:yellow">(A)Client request</span>|                |                     |
     |      <span style="color:yellow">Authorization</span>|                |                     |
     |<------------------|                |                     |
     |- - - - - - - - - - - - - - - - - ->|                     |
     |                   |                |                     |
     |<span style="color:red">(B) Resource Owner</span> |                |                     |
     |<span style="color:red">Grants authorization</span>                |                     |
     |----------------------------------->|                     |
     |                   |<- - - - - - - -|                     |
     |                   |                |                     |
     |                   |<span style="color:yellow">(C) Client send</span> |                     |
     |                   |  <span style="color:yellow">Authorization</span> |                     |
     |                   |          <span style="color:yellow">grant</span> |                     | 
     |                   |--------------->|                     |
     |                   |                |                     |
     |                   | <span style="color:yellowgreen">(D)Autorization</span>|                     |
     |                   |    <span style="color:yellowgreen">server sends</span>|                     |
     |                   |    <span style="color:yellowgreen">access token</span>|                     |
     |                   |<---------------|                     |
     |                   |                |                     |
     |                   |<span style="color:yellow">(E)Client sends</span> |                     |
     |                   |<span style="color:yellow">Access Token</span>    |                     |
     |                   |------------------------------------->|
     |                   |                |                     |
     |                   |                |<span style="color:violet">(F)Protected resource</span>|
     |                   |                |       <span style="color:violet">sends resource</span>|
     |                   |<-------------------------------------|
     |                   |                |                     |
     -                   -                -                     -                                   
						</pre>
					</section>

					<section>
						<h3>What oAuth is and is not</h3>
						<ul>
							<li>Is not Defined outside HTTP</li>
							<li>Is "requiring" TLS</li>
							<li>Is not an authentication protocol</li>
							<li>Is not processing authorization</li>
							<li>Is not defining user-to-user delegation</li>
							<li>Is not defining a token format</li>
							<li>Is not defining crypto methods</li>
							<li>Is not a single protocol - </br>it supports multiple use cases</li>
						</ul>
					</section>

					<section>
						<h2>Permissions, Consent, delegation, users vs. machine, user vs. admin</h2>
					</section>



					<section>
						<h2>Tokens</h2>
						<ul>
							<li><span style="color:red">Access token</span></br><span style="font-size: 80%">Access tokens are credentials used to access protected resources.  An access token is a string representing an authorization issued to the	client.  The string is usually opaque to the client.  Tokens represent specific scopes and durations of access, granted by the resource owner, and enforced by the resource server and authorization server.</span>
							 </li>
						</ul>						
					</section>

					<section>
							<h2>Tokens</h2>
							<ul>
								<li><span style="color:red">Refresh token</span></br><span style="font-size: 80%">Refresh tokens are credentials used to obtain access tokens.  Refresh tokens are issued to the client by the authorization server and are used to obtain a new access token when the current access token becomes invalid or expires, or to obtain additional access tokens with identical or narrower scope (access tokens may have a shorter lifetime and fewer permissions than authorized by the resource	owner).  Issuing a refresh token is optional at the discretion of the authorization server.  If the authorization server issues a refresh token, it is included when issuing an access token.</span>
								 </li>
							</ul>						
					</section>

					<section>
						<h3>Azure AD (AAD) issues JWT tokens</h3>
						<small><a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web Token (JWT)(RFC7519)</a></small></br>
						<div style="font-size:40%; text-align: center;">eyJ0eXAiOiJKV1QiLA0KICJhbGciOiJIUzI1NiJ9<span style="color:red">.</span></br>eyJpc3MiOiJqb2UiLA0KICJleHAiOjEzMDA4MTkzODAsDQogImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ<span style="color:red">.</span></br>dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</div>
						<p></p>
						<pre><code class="hljs">
{
  "typ": "JWT",
  "alg": "HS256"
}.
{
  "iss": "joe",
  "exp": 1300819380,
}.
[Signature]
						</code> 
						</pre>	
						<small>Header, Payload with claims and Signature -  based64 encoded</small>

					</section>
	

					<section>
						<h3>Clients</h3>
						<ul>
							<li>Clients are either confidential or public
								<ul>
									<li><span style="color:red">Confidential:</span> Clients capable of maintaining the confidentiality of their credentials. (Web apps)</li>
									<li><span style="color:red">Public:</span> Clients incapable of maintaining the confidentiality of their credentials (SPA, Native) </li>
								</ul>
							</li>
							<li>Clients provide a redirection URI</li>
						</ul>
					</section>
				
					<section>
						<h3>Protocol Endpoints</h3>
						<ul>
							<li><span style="color:red">Authorization endpoint:</span> used by client to get authorization from resource owner </li>
							<li><span style="color:red">Token endpoint:</span> used by client to exchange authorization grant for an access token</li>
							<li><span style="color:red">Redirection endpoint:</span> used by authorization server to return response containing creds to client</li>
						</ul>
					</section>
					
					<section>
						<h3>Interaction between actors</h3>
						<ul>
							<li><span style="color:red">Back-channel</span>: Communication happening outside the view of the resource owner and the user agent (like browser)</li>
							<li><span style="color:red">Front-channel</span>: Communication between to parties through an intermediate (the web browser)</li>
							<li><span style="color:red">Protocol endpoints</span></li>
						
						</ul>

					</section>

					<section>
							<h3>Obtaining authorization - the oauth Dance</h3>
							<blockquote> To request an access token, the client obtains authorization from the resource owner.  The authorization is expressed in the form of an authorization grant, which the client uses to request the access token.  OAuth defines four grant types: <span style="color:red">authorization code, implicit, resource owner password credentials</span>, and <span style="color:red">client credentials</span>.  It also provides an extension mechanism for defining additional grant types.</blockquote>
					</section>
						
					<section>
						<h3> Authorization Code Grant</h3>
						<pre style="font-size: 40%;">

+----------+
| Resource |
|   Owner  |
|          |
+----------+
     ^
     |
    (B)
+----|-----+          Client Identifier      +---------------+
|         -+----(A)-- & Redirection URI ---->|               |
|  User-   |                                 | Authorization |
|  Agent  -+----(B)-- User authenticates --->|     Server    |
|          |                                 |               |
|         -+----(C)-- Authorization Code ---<|               |
+-|----|---+                                 +---------------+
  |    |                                         ^      v
 (A)  (C)                                        |      |
  |    |                                         |      |
  ^    v                                         |      |
+---------+                                      |      |
|         |>---(D)-- Authorization Code ---------'      |
|  Client |          & Redirection URI                  |
|         |                                             |
|         |<---(E)----- Access Token -------------------'
+---------+       (w/ Optional Refresh Token)
					   
							
						</pre>
					</section>

					<section>
						<h4> Implicit Grant</h4>
						<pre style="font-size: 40%;">
+----------+
| Resource |
|  Owner   |
|          |
+----------+
     ^
     |
    (B)
+----|-----+          Client Identifier     +---------------+
|         -+----(A)-- & Redirection URI --->|               |
|  User-   |                                | Authorization |
|  Agent  -|----(B)-- User authenticates -->|     Server    |
|          |                                |               |
|          |<---(C)--- Redirection URI ----<|               |
|          |          with Access Token     +---------------+
|          |            in Fragment
|          |                                +---------------+
|          |----(D)--- Redirection URI ---->|   Web-Hosted  |
|          |          without Fragment      |     Client    |
|          |                                |    Resource   |
|     (F)  |<---(E)------- Script ---------<|               |
|          |                                +---------------+
+-|--------+
  |    |
 (A)  (G) Access Token
  |    |
  ^    v
+---------+
|         |
|  Client |
|         |
+---------+			   			  	
Client lives inside browser (user agent)						
						</pre>
					</section>


					<section>
						<h2>OpenID Connect (<a href="https://openid.net/connect/" target="_blank">OICD</a>)</h2>
						<small><span style="color:red">Authentication</span> protocol built on-top of oAuth2</small>
						
						<table>
							<thead>
								<tr>
									<td>oAuth2</td>
									<td>OICD</td>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Resouce owner</td>
									<td>User</td>
								</tr>
								<tr>
									<td>Client</td>
									<td>Relying party</td>
								</tr>
								<tr>
									<td>Authorisation server, Protected resource</td>
									<td>Identity provider</td>
								</tr>
							</tbody>
						</table>
					</section>

					<section>
						<h2>OpenID Connect (OICD)</h2>
						<ul style="font-size: 70%";">
							<li>New <span style="color:red">IDToken</span> received upon sucessfull authentication</li>
							<li>Access tokens are not proof of authentication. They are not intended for client - rather the protected resource</li>
							<li>IDToken's are given to client along with Aaccess tokens</li>
							<li>IDTokens' are signes JWT tokens.</li>
							<li>ID tokens contains claims such as</li>
								<ul>
									<li>iss - issuer of the token</li>
									<li>sub - subject - user id from identity provider</li>
									<li>aud - audience - id for relying party</li>
									<li>exp - expiration time stamp</li>
								</ul>
							<li>More documentation on the <a href"https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc" target="_blank">Microsoft Identity Platform</a> doc pages</li>
						</ul>
					</section>

					<section>
						<h3>Example ID Token</h3>
						<small>Azure AD ID Token <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens" target="_blank">claims</a></small>
						<pre><code class="hljs" style="font-size: 60%;">
{
	"typ": "JWT",
	"alg": "RS256"
	}.{
	"aud": "cab2507d-e7d1-46fd-9580-ea7de0cd02ea",
	"iss": "https://login.microsoftonline.com/../v2.0",
	"exp": 1571657734,
	"name": "Jon Doe",
	"oid": "..",
	"roles": [
		"Admin"
	],
	"sub": "..",
	}.[Signature]

						</code> 
						</pre>	
					</section>


					<section>
						<h1>Please note ...</h1>
						<ul>
							<li>Use Azure AD v2 endpoints whenever possible</li>
							<li>Be aware of doc and v1 vs. v2 (it's easy to read the wrong one) </li>
						</ul>
					</section>


				</section>

<!-- Exercise 1 -->
				<section>
					<section>
						<h1>Exercise - 1</h1>
						<h2>Raw Authorization Code Grant</h2>
					</section>	

					<section>
						<h2>Steps</h2>
						<ul style="font-size: 80%;">
							<li>Clone github repository <a href"https://github.com/larskaare/WebAuthAuthorAndOtherCreatures" target="_blank">https://github.com/larskaare/WebAuthAuthorAndOtherCreatures</a></li>
							<li>Investigate <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank">spec</a> and doc on <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">Azure</a></li>
							<li>Register app object in <a href="https://portal.azure.com" target="_blank">Azure AD</a></li>
							<li>Set-up postman</li>
							<li>Request authorization code</li>
							<li>Request an access token</li>
							<li>Explore tokens</li>
							<li>Use access token</li>
						</ul>
					</section>
					<section>
						<h3>Register application in Azure AD</h3>
						<ul style="font-size: 80%;">
							<li>Navigate to <a href="https://portal.azure.com" target="_blank">portal.azure.com</a> and find Azure Active Directory</li>
							<li>Select App registrations</br>(App registration vs. Enterprise Applications</li>
							<li>Register new application</li>
								<ul>
									<li>Activate "Application developer role" in "Privileged Identiy Management"</li>
									<li><span style="color:red">Name</span>: (inital)-(aatest) or something else</li>
									<li><span style="color:red">Type</span>: Single tenant</li>
									<li><span style="color:red">Redirect uri</span>: http://localhost/auth</li>
								</ul>
							<li>Explore options for the new app registration</li>
						</ul>
					</section>

					<section>
						<h3>Set-up Postman</h3>
						<ul>
							<li>Start Postman</li>
							<li>Import "Azure AD v2.0 Protocols.postman_collection.json"</li>
						</ul>
					</section>

					<section>
						<h3>Request authorization code</h3>
						<ul style="font-size: 70%;">
							<li>Import "Azure AD v2.0 Protocols.postman_collection.json" from EX-1 folder</li>
							<li>Select "Oauth 2.0 Authorization Code Flow" -> GET Autorization request</li>					
							<li>Explore "endpoints" for application registration (Azure Portal)"</li>
							<li>Copy and substitute oAuth2 Authorization endpoint v2 to GET request</li>
							<li>Copy "client_id" to GET request parameter</li>
							<li>Change "redirect_url" to "http://localhost/auth" for GET request parameter</li>
							<li>Look at scope for GET request</li>
							<li>Copy GET request to clip board and execute from web browser</li>
							<li>Copy authorization code from "code" parameter in request</li>
							<li>Explore changig "scope" and "redirect uri" for GET request</li>
							<li>Why do we have to execute request in web browser?</li>
							<li>Discuss security considerations</li>
							<li><span style="color:red">Good practice</span> : remove the localhost redirect from production applications</li>
						</ul>
					</section>
					
					<section>
						<h3>Request an access token</h3>
						<ul style="font-size: 70%;">
								<li>Select "POST - Token Request - Auth Code" from Postman collection</li>
								<li>Copy and substitute oAuth2 Token endpoint v2 to POST request</li>
								<li>Define client secret for application in Azure Portal</li>
								<li>Update body for POST request <span style="color:red">client_id, redirect_uri, client_secret, code</span><br>(code is from GET request)</li>		
								<li>Send POST request</li>
								<li>(Handle SSL "issues")</li>
								<li>Explore response</li>
								<li>Discuss security considerations (SSL, secrets, certificates, public vs. confidential client)</li>
								<li><span style="color:red">Good practice</span> : </li>
							</ul>
					</section>

					<section>
						<h3>Explore tokens</h3>
						<ul>
							<li>Use <a href="https://jwt.ms" target="_blank">https://jwt.ms</a> to explore tokens</li>
							<li>Explore tokens, claims and dates</br> (access_token, refresh_token, id_token)</li>
							<li>Experiment with scope param?</li>
							<li>Discuss claims, optiona claims, application manifrst</li>
							<li>Discuss security considerations (token validation, token storage)</li>
							<li><span style="color:red">Good practice</span>: Don't uses access tokens as authentication. Access tokens are for the protected resource </li>
						</ul>
					</section>

				</section>

				<section>
					<section>
						<h1>Exercise 2</h1>
						<h3>Prepare a web application</h3>
					</section>

					<section>
						<h3>Verify the environment</h3>
						<code class="hljs">$ git --version</code>
						<code class="hljs">$ node --version</code>
						<code class="hljs">$ npm --version</code>
					</section>

					<section>
						<h3>Generate default web application</h3>
						<p>We will create a web application running node.js on the back-end using the <a href="https://expressjs.com/" target="_blank">Express framework</a></p>
						<ul style="font-size:80%">
							<li>Navigate to <span style="color:yellow">"./ex-2"</span></li>
							<li>Install npx (execute npm package binaries)</li>
							<code class="hljs">$ npm install -g npx</code>
							<li>Running the express generator</li>
							<code class="hljs">$ npx express-generator --view=pug</code>
							<li>Installing dependencies</li>
							<code class="hljs">$ npm install</code>
						</ul>
					</section>

					<section>
						<h3>Let's add a linter - thats good practice</h3>
						<ul style="font-size:80%">
							<li>Install eslint
								<code class="hljs">$ npm install eslint --save-dev</code>
							</li>
							<li>Intialise <a href="https://www.npmjs.com/package/eslint" target="_blank">eslint</a></li>
								<code class="hljs">$ ./node_modules/.bin/eslint --init</code>
							<li>Run the linter
								<code class="hljs">$ ./node_modules/.bin/eslint . --ext .js</code>
							</li>
							<li>Explore results from linter, investigate <span style="color:yellow">"/.eslintrc.json"</span></li>
						</ul>
					</section>
				</section>
				
				<section>
						<section>
							<h1>Exercise 3</h1>
							<h3>Add authentication</h3>
							<small>OAuth2, OpenID, Auth Code Grant Flow</small>
						</section>

						<section>
							<h3>Preparing the code</h3>
							<ul>
								<li>Navigate to the <span style="color: yellow">./ex-3</span> directory</li>
								<li>Install dependencies
									<code class="hljs">$ npm install</code>
								</li>
							</ul>
						</section>
						
						<section>
							<h3>Exploring the code</h3>
							<ul>
								<li>Environment variables</li>
								<li>Secrets</li>
								<li>Handling the authentication</li>
								<li>Staging environments - logging</li>
							</ul>
						</section>

						<section>
							<h3>Environment variables</h3>
							<ul>
								<li><span style="color:yellow">PORT</span> in ./bin/www</li>
								<li><span style="color:yellow">NODE_ENV, CLIENT_SECRET</span> in ./app.js</li>
								<li>Define environment variables
									<code class="hljs">$ export PORT=3000</code>
									<code class="hljs">$ export CLIENT_SECRET=[your secret]</code>
								</li>
								<li><span style="color:red">Good practice</span>: 
									Move config into config files, potentially .env files (that are defined in .gitignore and/or kept outside version control, stored outside git)	
								</li>
							</ul>
						</section>

						<section>
							<h3>Secrets</h3>
							<ul>
								<li><span style="color:red">Good practice</span>: 
									Keep secrets outside version control!	
								</li>
								<li><span style="color:red">Ok practice</span>: 
									Inject secrets as environment vartiables	
								</li>
								<li><span style="color:red">Good practice</span>: 
									Store secrets in keyvaults (explore if managed identities are available (MSI)) 	
								</li>
							</ul>
						</section>

						<section>
							<h3>Handling the authentication</h3>
							<ul>
								<li>Explore authentication code in <span style="color:yellow">./app.js</span></li>
								<li>Explore endpoints in <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview" target="_blank">Azure</a> for application object</li>
								<li>Explore application config (client_id, secret, callback)</li>
								<li>Explore authentication flow in code (auth, redirect, callback)</li>
								<li><span style="color:red">Good practice</span>: 
									Be conscious of what you put in log files!!	
								</li>
							</ul>
						</section>

						<section>
								<h3>Staging environments - logging </h3>
								<ul>
									<li>Explore logging logic in <span style="color:yellow">./app.js</span></li>
									<li>Different logging level dependent on environment (debug, development, production)</li>
									<li><span style="color:red">Good practice</span>: 
										Have a strategy for log purpose and transports (why you log, where you store/not store)	
									</li>
								</ul>
						</section>

						<section>
								<h3>Config, Run and Explore </h3>
								<ul>
									<li>Configure the <span style="color:yellow">authServer</span> object in app.js</li>
									<li>Configure the <span style="color:yellow">client</span> object in app.js</li>
									<li>Configure environment variables (PORT, NODE_ENV and CLIENT_SECRET</li>
									<li>Run web application
										<code class="hljs">$ npm start</code>
									</li>
									<li>Explore; change config - change auth params - observe error messages, observe logging behavior </li>
								</ul>
						</section>

						<section>
								<h3>We are authenticated</h3>
								<p>and have a code that can be used only once and that will expire shortly (spec says max 10 minutes) </p>
						</section>

						<section>
							<h3>A challenge (if time)</h3>
							<p>Change the authentication flow to use <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc" target="_blank">openID Connect</a> and get a id_token and/or a code as part of the sign in request</p>
					</section>


					</section>
					
				
					<section>
							<section>
								<h1>Exercise 4</h1>
								<h3>Getting an access token</h3>
							</section>
		
							<section>
								<h3>Outline</h3>
								<ul>
									<li>Prepare environment (ex-4)</li>
									<li>Config, run and explore</li>
									<li>Explore tokens - good practices++</li>
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: yellow">./ex-4</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Explore authentication code in <span style="color:yellow">./app.js</span></li>
										<li>New logic in <span style="color:yellow">app.get('/callback', function(req, res){</span></li>
										<li>Creating POST request to token endpoint</li>
										<li>Body contains oAuth2 params</li>
										<li>Header uses basic auth for client credentials (remember to base64 encode)</li>
										</br>
										<li>Explore routing/views in application</li>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<ul>
										<li>Configure the <span style="color:yellow">authServer</span> object in app.js</li>
										<li>Configure the <span style="color:yellow">client</span> object in app.js</li>
										<li>Configure environment variables (PORT, NODE_ENV and CLIENT_SECRET</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore; <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">spec</a>, scope - why is <span style="color:yellow">Mail.Read openid profile email</span> default? </li>
										<li>Explore what <a href="https://myapps.microsoft.com/" target="_blank">consent</a> you have given to apps on Azure AD. Test revoking for test app.</li>
									</ul>
							</section>

					</section>
					
					<section>
							<section>
								<h1>Exercise 5</h1>
								<h3>Scope</h3>
								<small>Consent, Graph explorer, tokens - security, state - session</small>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore the MS Graph Explorer</li>
										<li>Discuss Permissions and Consent</li>
										<li>Prepare environment (ex-5)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>
	
							<section>
								<h3>The MS Graph Explorer</h3>
								<ul>
									<li>Open the <a href="https://developer.microsoft.com/en-us/graph/graph-explorer"
									target="_blank">MS Graph Explorer</a></li>
									<li>Sign in</li>
									<li>Query the <span style="color:yellow">/v1.0/me</span> endpoint</li>
									<li>Query the <span style="color:yellow">/v1.0/me/memberOf</span> endpoint</li>
									<li>Query the <span style="color:yellow">v1.0/me/mailFolders('Inbox')/messages?$select=sender,subject</span> endpoint</li>
									<li>Explore the <a href="https://docs.microsoft.com/nb-no/graph/api/overview?view=graph-rest-1.0" target="_blank">graph api</a> documentation</li>
									<li>Play around with other endpoints, filtering, permissions, consent</li>
								</ul>
							</section>		

							<section>
								<h3>Permissions & Consent</h3>
								<ul style="font-size: 80%;">
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Documentation</a> of Permission and Consent on the MS Identity platform </li>
									<li>Scope = requested permissions</li>
									<li>Delegated permissions, for signed-in-user, user or admin consent</li>
									<li>Application permission, without signed-in-user, admin consent only</li>
									<li>Effective permissions - least privileged between app and user (Example App has User.ReadWriteAll, User has no admin right = Effective rights will be only to update own profile  </li>
									<li>Effective permission for application permission will be the full permission</li>
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: yellow">./ex-5</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Explore authentication code in <span style="color:yellow">./app.js</span></li>
										<li>Adding session management (express-session)</li>
										<li>Adding new route to show mail (/routes/mail.js)</li>
										<li>Adding capabilities to scope (Mail.Read, User.Read)</li>
										<li>Storing access_token in session</li>
										<li>Explore routing/views in application (<span style="color:yellow">app.use('/mail', mailRouter);</span>)</li>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<ul>
										<li>Configure the <span style="color:yellow">authServer</span> object in app.js</li>
										<li>Configure the <span style="color:yellow">client</span> object in app.js</li>
										<li>Configure environment variables (PORT, NODE_ENV and CLIENT_SECRET</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the new mail functionality</li>
									</ul>
							</section>


							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Access_token storage</li>
										<li>Increase user experience - extend session management to persist user data, refresh tokens??</li>
										<li>Access_token validation - is not happening</li>
										<li><a href="https://tools.ietf.org/html/rfc6819" target="_blank">oAuth2 Threat Model and Security Considerations</a></li>
										<li><a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics" target="_blank"> OAuth Security Topics</a></li>
										<li><span style="color:red">Good practice</span>: 
											It's a lot of hard work to get A&A done properly - USE a Framework!
										</li>
										<li><span style="color:red">Good practice</span>: 
											Protocols (and Frameworks) does not guarantee security, Developers Do
										</li>
										<li><span style="color:red">Good practice</span>: 
											Only request the minimum scope, dynamically - not all at once
										</li>
									</ul>
								</section>
	


					</section>
						
					<section>
							<section>
								<h1>Exercise 6</h1>
								<h3>Use frameworks!</h3>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore available frameworks for oAuth2</li>
										<li>Prepare environment (ex-6)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Font-end vs. back-end communication channels</li>
										<li>Session handling</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>

							<section>
								<h3>Frameworks</h3>
								<ul>
									<li>Explore the <span style="color:yellow">quickstart</span> of the application object</li>
									<li>Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-v2-libraries"
										target="_blank">Authentication libraries</a> at the MS Identity Platform</li>
									<li>Explore <a href="https://oauth.net/code/"
											target="_blank">Authentication libraries</a> at oauth.net</li>
									<li>Explore <a href="https://github.com/AzureADQuickStarts"
												target="_blank">the Azure AD Quick Starts</a></li>		
									<li><span style="color:red">Good practice</span>: 
										Use the latest library from Microsoft, MSAL, when available
									</li>	
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: yellow">./ex-6</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Introducing <a href="http://www.passportjs.org/" target="_blank">passport.js</a></li>
										<li>Introducing <a href="https://github.com/AzureAD/passport-azure-ad" target="_blank">passport-azure-ad</a></li>
										<li>./src/</li>
										<ul>
											<li style="color:yellow">app.js</li>
											<li>authutils.js</li>
											<li>logHelper.js</li>
										</ul>
										<li style="color:yellow">config/config.js</li>
										<li>./routes/</li>
										<ul>
												<li>index.js</li>
												<li>mail.js</li>
												<li>userinformation.js</li>
											</ul>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<ul>
										<li>Update configuration in <span style="color:yellow">./config/config.js</span> (clientid)</li>
										<li>Update the AD application object with new <span style="color:yellow">redirect url</span></li>
										<li>Configure environment variables (PORT, NODE_ENV and CLIENT_SECRET</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the application</li>
										<li>Change "node_env" and observe whats happening to the logging</li>
									</ul>
							</section>

							<section>
								<h3>Font-end vs. back-end communication channels</h3>
								<ul>
									<li>Font-end: Browser (User agent) to</li>
									<ul>
										<li>back-end (localhost:3000/mail, /userinfo)</li>
										<li>Azure AD authentication</li>
									</ul>
									<li>Back-end: Client (Web app) to</li>
									<ul>
										<li>Azure ADd authorize (getting access token)</li>
										<li>Accessing the MS Graph on behalf of user</li>
									</ul>
									<li>A tool like <a href="https://portswigger.net/burp/communitydownload" target="_blank">Burp Community Edition</a> could be used to investigate/debug front-end and back-end traffic when on localhost</li>
								</ul>
								</section>

								<section>
										<h3>Session handling</h3>
										<ul>
											<li>Our web application use express and <a href="https://github.com/expressjs/session" target="_blank">express-session</a> to manage user session</li>
											<li>The session cookie is named connect.sid</li>
											<li>The cookie only stores session id</li>
											<li>The cookie is signed (to detect tampering)</li>
											<li>Session data is stored on the back-end</li>
											<li>A lesser secure(?) alternative could be to store session data in the cookie</li>
											<li><span style="color:yellow">Task:</span> Open the developer tools in the browser and locate the session cookie for our app</li>
										</ul>
										</section>	

							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Access_token storage</li>
										<li>Persistent Session storage (from memory to database?)</li>
										<li>Cookie signing keys</li>
										<li>Access_token is being validated</li>
										<li>Only authenticated users are getting access to end-points (<span style="color:yellow">ensureAuthenticated</span>)</li>
										<li><span style="color:red">Good practice</span>: 
											Follow security advices for all frameworks (Example:  
											<a href="https://expressjs.com/en/advanced/best-practice-security.html" target="_blank">Express - Production Best Practices: Security</a>)</li>
									</ul>
								</section>

					</section>

					<section>
							<section>
								<h1>Exercise 7</h1>
								<h3>Authorization scenarios</h3>
								<h4>The Application Manifest</h4>
							</section>

							<section>
									<h3>Outline</h3>
									<ul style="font-size: 80%;">
										<li>Prepare environment (ex-7)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Scenario 1: Only people with valid account should have access</li>
										<li>Scenario 2: Only defined users/groups should have access</li>
										<li>Scenario 3: Application roles to handele authorisation</li>
										<li>Accessing 3d party api's protected by oauth2</li>
									</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: yellow">./ex-7</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li style="color:yellow">src/app.js</li>
											<ul>
												<li>passport.use(....)</br>Creating authInfo object in profile to store relevant claims</li>
											</ul>
											<li style="color:yellow">view/userinfo.pug</li>
											<ul>
												<li>Showing information about groups & roles in claim</li>
											</ul></br>
											<li>We are not activation authorization (other than login), just retrieving the information to do it</li>
									
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<ul>
										<li>Update configuration in <span style="color:yellow">./config/config.js</span> (clientid)</li>
										<li>Verify the AD application object <span style="color:yellow">redirect url</span></li>
										<li>Configure environment variables (PORT, NODE_ENV and CLIENT_SECRET</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the "user information" part of the web application</li>
									</ul>
							</section>

							<section>
								<h3>Scenario 1:</br> Only people with valid account should have access</h3>
								<ul>
									<li><span style="color:yellow">App Registration (object)</span> vs. <span style="color:yellow">Enterprise Application (instance, multi-tentant)</span></li>
									<li>In "Enterprise Applications" (Azure AD) explore the property section for your application</li>
									<ul>
										<li>"Enables for users to sign-in?"</li>
										<li>"User assignment required?"</br>(User must be assigned to be able to sign in)</li>
									</ul>
								</ul>
								<li><span style="color:yellow">Sign-in enabled</span> and <span style="color:yellow">no user assignment required = available to everyone with valid user account in tenant</li>
							</section>

							<section>
									<h3>Scenario 2:</br> Only defined users/groups should have access</<br></h3>
									<ul style="font-size: 90%;">
										<li>There are "many" ways to achive this scenario</li>
										<li>1) Managing the App Object</li>
											<ul>
												<li>Set "User assignment" to "Yes" - in App property</li>
												<li>Add users and groups in "Users & Groups" - in App property</li>
											</ul>
										<li>2) Alter application manifest to include security groups</li>
										<ul>
											<li>The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-app-manifest" target="_blank">Application Manifest</a> defines all the attributes and behavior of an applicaton object</li>
											<li><span style="color:yellow">groupMembershipClaims</span> to include <span style="color:yellow">"SecurityGroup"</span></li>
											<li>Alter - save - explore "user information part in our web app</li>
											<li>This approach have some limitations (size) </li>
										</ul>
									</ul>
								</section>

								<section>
										<h3>Scenario 3: Application roles</h3>
										<ul style="font-size: 80%;">
											<li>Application roles implement RBAC</li>
											<li>App admins grant permissions to roles, users and groups are assigned to roles</li>
											<li>Define application role in app manifest (<a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps" target="_blank">doc</a>)</br>ID is a self generated GUID and must be unique</li>	
											<pre><code class="hljs">
"appRoles": [
{
  "allowedMemberTypes": ["User"],
  "displayName": "Writer",
  "id": "b421319c-3e45-4685-aaf2-b1282ad05a6f",
  "isEnabled": true,
  "description": "Writers Have the ability to create tasks.",
  "value": "Writer"
}
],
"availableToOtherTenants": false,
											</code></pre>		
										<li>Alter manifest with "Writer" app role". Save</li>
										<li>Assign a user or group to the "Write roles" in "Enterprise apps" - "Users and Groups"</li>			
										<li>Explore the "User information" part of our web app</li>				
										</ul>
									</section>
	
									<section>
										<h3>Accessing 3d party api's protected by oAuth2</h3>
										<ul style="font-size: 80%;">
											<li>Add/Include api resource to scope</li>
											<li>Hit token endpoint to request an access token</li>
											<li>Use access token to access api</li>
											<li>Explore the mail part of our web application (/routes/mail.js)</li>
											<li>Explore Static vs. Dynamic permissions</li>
											<ul>
												<li><a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Best practice</a></li>
												<li>Change scope to include <span style="color:yellow">
													https://graph.microsoft.com/Contacts.read</span> from code (scope config) and/or "api permissions" in app definition (AD) </li>
												<li>Remember to restart app after changes (and do a new login)</li>
												<li>Add other resources from the MS Graph Explorer and observe consent flow</li>
											</ul>
										</ul>
									</section>

					</section>


					<section>
							<section>
								<h1>Exercise 8</h1>
								<h3>Refresh tokens</h3>
								</br><small>Re-fresh alg</small>
								</br><small>Expect more heavy lifting from framework</small>
								</br><small>Look at MSAL, roadmap ++</small>
							</section>

					</section>
					

					<section>
							<section>
								<h1>Exercise 9</h1>
								<h3>Single Page Web Application (SPA)</h3>
								<small>Implicit grant flow </small>
								<small>Sec implication, no-refresh, ....</small>
							</section>

					</section>

					<section>
							<section>
								<h1>Exercise 10</h1>
								<h3>Protecting web api's</h3>
								<small>MSAL</small>
								</br><small>AD App, Token validation</small>
								</br><small>Azure API GW - Apim</small>
							</section>

					</section>


					<section>
							<section>
								<h1>Security</h1>

							</section>

					</section>


					<section>
							<section>
								<h1>Exercise 11</h1></h2>
								<h3>Deployment - DevOps - Radix</h1>
								<small>Let's put a project into Radix</small>
							</br><small>Create a new project based on ex-10??</small>
							</section>

					</section>

					<section>
							<section>
								<h1>Hack your own project</h1>
							</section>

					</section>



			</div>

		</div>

		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,
				slideNumber: true,
				hash: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true },
					{ src: 'plugin/search/search.js', async: true },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
